{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow-sm p-4">
            <h2 class="mb-4 text-success">Create Account</h2>
            <form method="POST">
                <input type="text" name="name" class="form-control mb-3" placeholder="Name" required>
                <input type="email" name="email" class="form-control mb-3" placeholder="Email" required>
                <input type="password" name="password" class="form-control mb-3" placeholder="Password" required>
                <select name="role" class="form-control mb-3" id="role-select" required>
                    <option value="">Select Role</option>
                    <option value="patient">Patient</option>
                    <option value="doctor">Doctor</option>
                    <option value="pharmacy">Pharmacy</option>
                </select>
                <div id="doctor-fields" style="display:none;">
                    <input type="text" name="specialty" class="form-control mb-3" placeholder="Specialty">
                </div>
                <div id="pharmacy-fields" style="display:none;">
                    <input type="text" name="pharmacy_name" class="form-control mb-3" placeholder="Pharmacy Name">
                    <input type="text" name="location" class="form-control mb-3" placeholder="Location">
                    <input type="text" name="hours" class="form-control mb-3" placeholder="Operating Hours">
                    <!-- Map for selecting location -->
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <div id="map" style="height: 250px; margin-bottom: 15px;"></div>
                </div>
                <button type="submit" class="btn btn-success w-100">Sign Up</button>
            </form>
            <p class="mt-3 text-center">Already have an account? <a href="/login">Login</a></p>
        </div>
    </div>
</div>
<script>
    document.querySelector('select[name="role"]').addEventListener('change', function () {
        document.getElementById('doctor-fields').style.display = this.value === 'doctor' ? 'block' : 'none';
        document.getElementById('pharmacy-fields').style.display = this.value === 'pharmacy' ? 'block' : 'none';
        if (this.value === 'pharmacy') {
            setTimeout(function() {
                if (!window.leafletLoaded) {
                    var script = document.createElement('script');
                    script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
                    script.onload = function() {
                        window.leafletLoaded = true;
                        initMap();
                    };
                    document.body.appendChild(script);
                    var link = document.createElement('link');
                    link.rel = "stylesheet";
                    link.href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
                    document.head.appendChild(link);
                } else {
                    initMap();
                }
            }, 100);
        }
    });

    function initMap() {
        if (window.map) return;
        var map = L.map('map').setView([30.3753, 69.3451], 5); // Default: Pakistan
        window.map = map;
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        var marker;
        map.on('click', function(e) {
            if (marker) map.removeLayer(marker);
            marker = L.marker(e.latlng).addTo(map);
            document.getElementById('latitude').value = e.latlng.lat;
            document.getElementById('longitude').value = e.latlng.lng;
        });
    }
</script>
{% endblock %}